AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  pNamePrefix:
    Type: String
#    Default: 'testnetalpha'
#  pDomain:
#    Type: String
#  pSubdomain:
#    Type: String
  pPublicNodeDomain:
    Type: String
#    Default: 'public-node-0.testnet-alpha.flux.vote.'
  pOffset:
    Type: String
    Default: ''


Resources:
  rChaincodeCr:
    Type: Custom::Chaincode
    Properties:
      ServiceToken: !GetAtt rChaincodeLambda.Arn
      pNamePrefix: !Ref pNamePrefix
#      pDomain: !Ref pDomain
#      pSubdomain: !Ref pSubdomain
      pPublicNodeDomain: !Ref pPublicNodeDomain
      pSmartContracts:
        - Name: membership
          Type: deploy
        - Name: bblib-v7
          Type: deploy
        - Libraries:
            __./contracts/BBLib.v7.sol:BBLibV7______: $bblib-v7
            somethingelsethatisntused: athsng!
          Name: bbfarm
          Type: deploy
        - Name: sv-backend
          Type: deploy
        - Inputs:
            - '%self'
            # - 'uint256:0x48934839489348'
          Name: sv-payments
          Type: deploy
        - Name: sv-comm-auction
          Type: deploy
        - Inputs:
            - $sv-backend
            - $sv-payments
            - '%addr-ones'
            - $bbfarm
            - $sv-comm-auction
          Libraries:
            somelib: someval
          Name: sv-index
          Type: deploy

  rChaincodeLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: '../cr/chaincode'
      Runtime: python3.6
      Handler: 'chaincode.chaincode_handler'
      FunctionName: !Sub ${pNamePrefix}${pOffset}-chaincode-cr
      Timeout: 300
      Policies:
        - Statement:
          - Effect: Allow
            Action: ssm:GetParameter
            Resource:
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/sv-${pNamePrefix}-nodekey-service-publish"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/sv-${pNamePrefix}-param-*"
          - Effect: Allow
            Action:
              - ssm:PutParameter
              - ssm:DeleteParameter
            Resource:
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/sv-${pNamePrefix}-param-sc-*"
          - Effect: Allow
            Action:
              - ssm:DescribeParameters
            Resource:
              - '*'
#Outputs:
#  oMembershipAddr:
#    Value: !GetAtt rChaincodeCr.MembershipAddr
