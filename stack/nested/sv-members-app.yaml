AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  pNamePrefix:
    Type: String

  pMembershipContract:
    Type: String

  pApiDomainRaw:
    Type: String

  pEthHost:
    Type: String

  pCertArn:
    Type: String
    
  pApiDomain:
    Type: String

  pApiStageName:
    Type: String
    Default: svprod
    


Globals:
  Function:
    Runtime: python3.6
    Timeout: 180
    Environment:
      Variables:
        pMembershipContract: !Ref pMembershipContract

  Api:
    EndpointConfiguration: REGIONAL
    Cors: !Sub "'*.${pApiDomainRaw}'"


Resources:
#  rMembersLayer:
#    Type: AWS::Serverless::LayerVersion
#    Properties:
#      LayerName: !Sub sv-${pNamePrefix}-members-layer
#      Description: SV membership management python libs
#      ContentUri: ../app/members/deps
#      CompatibleRuntimes:
#        - python3.6

  rMembersOnboardFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub sv-${pNamePrefix}-members-lambda
      CodeUri: ../app/members
      Environment: {}
      Handler: ./api.onboard_handler
      Runtime: python3.6
#      Layers:
#        - !Ref rMembersLayer
      Events:
        web:
          Type: Api
          Properties:
            Path: /onboard
            Method: post
            RestApiId: !Ref rMembersOnboardApi

  rMembersListFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub sv-${pNamePrefix}-list-members-lambda
      CodeUri: ../app/members
      Environment: {}
      Handler: ./api.list_members_handler
      Runtime: python3.6
#      Layers:
#        - !Ref rMembersLayer
      Events:
        web:
          Type: Api
          Properties:
            Path: /list
            Method: get
            RestApiId: !Ref rMembersOnboardApi


  rMembersOnboardApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub sv-${pNamePrefix}-members-onboard-api
      StageName: !Ref pApiStageName


#unk
      # Path: '/members/onboard'
#      Method: post
#      Auth:
#        CognitoAuth:
#          UserPoolArn: !Ref pAdminUserPoolArn


#  rMembersDeployment:
#    Type: AWS::ApiGateway::Deployment
#    Properties:
#      RestApiId: !Ref rMembersOnboardApi


#  rMembersStage:
#    Type: AWS::ApiGateway::Stage
#    Properties:
#      StageName: !Ref pApiStageName
#      RestApiId: !Ref rMembersOnboardApi
#      DeploymentId: !Ref rMembersDeployment
#

  rMembersBasePath:
    Type: AWS::ApiGateway::BasePathMapping
    DependsOn: rMembersOnboardApi
    Properties:
      BasePath: members
      DomainName: !Ref pApiDomain
      Stage: !Ref pApiStageName
      RestApiId: !Ref rMembersOnboardApi


Outputs:
#  oMembersLayer:
#    Value: !Ref rMembersLayer
  oMembersOnboardFunction:
    Value: !Ref rMembersOnboardFunction
